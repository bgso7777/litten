# 개발 세션 - 2026-02-07 17:20

## 세션 개요
- **시작 시간:** 2026-02-07 17:20 KST
- **세션 이름:** 신규 개발 세션
- **이전 세션:** 2026-02-07-1558 (STT 개선 시도 실패 - 원상 복구 완료)

## 목표
텍스트 입력과 STT를 자유롭게 섞어 사용할 수 있도록 증분 삽입 방식으로 리팩토링

### 주요 변경 사항
1. **STT 로직 전면 수정 (증분 삽입 방식)**
   - 임시 span 방식(`_updatePartialSpan`, `_removePartialSpan`, `_replaceFinalText`) 제거
   - 증분 삽입 방식으로 재구현: 이전 인식 결과와 비교하여 새로 추가된 부분만 커서 위치에 삽입
   - 키보드 입력과 STT 입력이 커서 위치에서 자유롭게 섞이도록 개선

2. **녹음 기능 안정화**
   - STT 시작 직후 즉시 녹음 시작
   - try-catch로 녹음 실패가 STT를 방해하지 않도록 보장

3. **기타 설정**
   - pauseFor를 3~5초로 조정
   - 라이브러리의 insertText 사용으로 포커스 충돌 방지

## 진행 상황

### 업데이트 - 2026-02-20 21:28

**요약**: STT 커서 위치 입력 시도 - 다중 방식 시도 후 실패

**Git 변경 사항**:
- 수정됨: frontend/lib/widgets/text_tab.dart
- 수정됨: .claude/sessions/.current-session
- 추가됨: .claude/sessions/2026-02-07-1720.md
- 현재 브랜치: main (커밋: 6efe58e - 텍스트 입력 및 stt 동시 입력 실패)

**할 일 진행 상황**: 완료 5건, 진행 중 0건, 대기 중 0건
- ✓ 완료됨: 현재 STT 구현 방식 분석
- ✓ 완료됨: 커서 위치 기반 증분 입력 로직 구현
- ✓ 완료됨: STT 실시간 표시 방식으로 변경
- ✓ 완료됨: STT 실시간 증분 입력 로직 개선
- ✓ 완료됨: insertText 문제 해결 시도

**시도한 방법들 (모두 실패)**:

1. **증분 입력 방식 1차 시도**
   - `startsWith` 비교로 새로운 부분만 추가
   - 문제: "하나 둘 셋"에서 "하나"만 입력되고 중단
   - 원인: 한국어 STT의 띄어쓰기/단어 수정으로 startsWith 조건 실패

2. **회색 span 실시간 표시 방식**
   - 중간 결과를 회색 이탤릭으로 표시, 최종 결과에서 확정
   - 사용자 요구사항: "커서가 있는 곳에 실시간으로 입력" 불충족

3. **공통 접두사 비교 증분 입력**
   - 이전 텍스트와 현재 텍스트의 공통 접두사 길이 계산
   - 새로 추가된 부분만 substring으로 추출하여 삽입
   - 문제: "가나다라" 말했는데 "가나"만 입력
   - 원인: STT가 "가나" → "가 나다라"처럼 수정하면 공통 접두사 길이 불일치

4. **최종 결과만 입력 방식 (사용자 선택)**
   - 중간 결과 무시, finalResult에서만 전체 문장 삽입
   - 로그: `✅ 증분 텍스트 삽입: ... → success`
   - 실제: 화면에 텍스트 입력 안됨
   - 첫 번째는 입력됨, 두 번째부터 입력 안됨

5. **개선된 insertText 메서드**
   - 에디터 초기화 상태 확인 추가
   - `summernote('editor.insertText')` 사용
   - 50ms setTimeout으로 타이밍 조정
   - 결과: 여전히 입력 안됨

**발견된 근본 문제**:
- 증분 방식은 한국어 STT의 특성상 **원천적으로 불가능**
  - STT 엔진이 이전 인식을 수정/변경
  - 띄어쓰기 추가/제거
  - 단어 교체 (예: "하나님" → "하느님")
- `summernote('insertText')`가 비동기/타이밍 문제로 실제 DOM에 삽입 안됨
  - 로그: success 표시
  - 실제: 화면에 텍스트 없음

**코드 변경 내역**:
```dart
// text_tab.dart 주요 변경
- _lastPartialText 변수 제거
- _updatePartialSpan, _removePartialSpan 메서드 제거
- _replaceFinalText, _insertFinalText 메서드 제거
- onResult 콜백: 최종 결과만 처리하도록 단순화
- _insertIncrementalText: 에디터 초기화 확인, setTimeout 추가
- pauseFor: 10초 → 3초
```

**결론**:
모든 시도 실패. 현재 코드 상태는 불안정. 이전 안정 버전(session 2026-02-07-1300)으로 복구 필요.

**다음 단계 권장사항**:
1. Git으로 이전 안정 버전 복구
2. Span 방식 유지 (실시간 회색 표시 + 최종 확정)
3. 또는 완전히 다른 에디터 라이브러리 검토

**세션 상태**: ❌ 실패

---

## 세션 종료 요약

**종료 시간**: 2026-02-20 21:30 KST
**세션 소요 시간**: 약 13일 13시간 10분 (2026-02-07 17:20 ~ 2026-02-20 21:30)

### Git 요약
- **변경된 파일 수**: 2개
  - 수정됨: `frontend/lib/widgets/text_tab.dart`
  - 추가됨: `.claude/sessions/2026-02-07-1720.md`
- **수행된 커밋**: 0건 (변경사항 커밋되지 않음)
- **최종 git 상태**:
  - 브랜치: main
  - 마지막 커밋: 6efe58e - 텍스트 입력 및 stt 동시 입력 실패
  - 수정된 파일: 2개 (미커밋)

### 할 일 요약
- **완료된 작업**: 9건
  - ✓ iOS 앱 재빌드 및 시뮬레이터 실행
  - ✓ Android 앱 재빌드 및 에뮬레이터 실행
  - ✓ 현재 STT 구현 방식 분석
  - ✓ 커서 위치 기반 증분 입력 로직 구현
  - ✓ STT 실시간 표시 방식으로 변경
  - ✓ STT 실시간 증분 입력 로직 개선
  - ✓ insertText 문제 해결 시도
  - ✓ 커서 위치 로직 개선
  - ✓ 최종 결과만 입력 방식으로 변경

- **미완료 작업**: 0건 (모두 시도했으나 실패)

### 주요 성과
없음. 모든 시도 실패.

### 구현 시도한 기능 (모두 실패)
1. **STT 커서 위치 증분 입력** - 실패
2. **STT 실시간 입력** - 실패
3. **STT 최종 결과만 입력** - 실패

### 발생한 문제와 시도한 해결책

#### 문제 1: 증분 입력 방식에서 일부만 입력
- **현상**: "하나 둘 셋 넷"에서 "하나"만 입력
- **시도한 해결책**:
  - `startsWith` 조건 사용
  - 공통 접두사 길이 계산
- **결과**: 실패 (한국어 STT는 이전 인식을 수정하므로 근본적으로 불가능)

#### 문제 2: 커서가 다른 위치에 있으면 입력 안됨
- **현상**: "병규" → 엔터 → 텍스트 입력 → "삼 사" 시도하면 입력 안됨
- **시도한 해결책**:
  - 커서 위치 확인 로직 제거
  - `summernote('focus')` 추가
- **결과**: 부분적 성공

#### 문제 3: 최종 결과 입력이 화면에 반영 안됨
- **현상**: 로그에 `success` 표시되지만 화면에 텍스트 없음
- **시도한 해결책**:
  - 에디터 초기화 상태 확인
  - `summernote('editor.insertText')` 사용
  - 50ms setTimeout 추가
- **결과**: 실패 (근본 원인 미해결)

### 주요 변경 사항

#### text_tab.dart 변경 내역
```dart
// 제거된 코드
- String _lastPartialText = '';
- void _updatePartialSpan(String text) { ... }
- void _removePartialSpan() { ... }
- Future<void> _replaceFinalText(String text) { ... }
- void _insertFinalText(String text) { ... }

// 변경된 코드
- onResult 콜백: 중간 결과 무시, 최종 결과만 처리
- pauseFor: Duration(seconds: 10) → Duration(seconds: 3)

// 추가된 코드
- 에디터 초기화 확인: if (!summernote.data('summernote'))
- setTimeout을 사용한 비동기 텍스트 삽입
- summernote('editor.insertText') 메서드 사용
```

### 추가/제거된 종속성
없음

### 설정 변경 사항
- `pauseFor` 시간: 10초 → 3초

### 수행된 배포 단계
- iOS 빌드 및 실제 기기 설치: 7회
- Android 빌드 및 에뮬레이터 실행: 1회

### 얻은 교훈

1. **한국어 STT의 증분 입력은 불가능**
   - STT 엔진이 이전 인식을 지속적으로 수정
   - 띄어쓰기 추가/제거, 단어 교체 빈번
   - "하나님" → "하느님", "가나" → "가 나다라" 등
   - 공통 접두사 비교 방식도 무용지물

2. **Summernote의 insertText 비동기 문제**
   - `summernote('insertText')`가 실행은 되지만 DOM에 반영 안됨
   - 에디터 초기화 상태, 포커스, 타이밍 등 복합적 문제
   - JavaScript 로그와 실제 화면 상태 불일치

3. **이전 안정 버전의 중요성**
   - Span 방식은 실시간 표시는 안 되지만 안정적
   - 최종 결과 확정 시 정확히 입력됨
   - 실험적 변경 전 반드시 git commit 필요

### 완료되지 않은 작업

**주요 목표 미달성**: 텍스트 입력과 STT를 자유롭게 섞어 사용

**현재 상태**: 코드 불안정, 작동하지 않음

**필요한 작업**:
1. Git으로 안정 버전 복구 (`git checkout frontend/lib/widgets/text_tab.dart`)
2. 이전 세션(2026-02-07-1300)의 안정적인 Span 방식으로 복귀
3. 사용자에게 현실적인 대안 제시

### 미래 개발자를 위한 팁

#### ❌ 시도하지 마세요
- 한국어 STT의 증분 입력 방식
- `startsWith` 또는 공통 접두사 비교
- 실시간 커서 위치 추적

#### ✅ 권장 방식
1. **Span 방식 (현재 안정 버전)**
   - 중간 결과: 회색 이탤릭 span으로 표시
   - 최종 결과: span 제거 후 실제 텍스트로 확정
   - 장점: 안정적, 시각적 피드백
   - 단점: STT 중 키보드 입력 불가

2. **대체 에디터 검토**
   - Quill.js, TinyMCE, ProseMirror 등
   - 더 나은 커서 관리 및 비동기 처리

3. **STT 라이브러리 변경 검토**
   - `speech_to_text` 대신 다른 라이브러리
   - 더 세밀한 이벤트 제어 가능 여부 확인

#### 디버깅 시 참고사항
- Flutter 로그 `success`가 실제 성공을 의미하지 않음
- 반드시 화면 확인 필요
- JavaScript 비동기 타이밍 문제 주의

### 최종 권장사항

**즉시 수행**:
```bash
git checkout frontend/lib/widgets/text_tab.dart
```

**장기 계획**:
1. 사용자에게 Span 방식의 한계 설명
2. 다른 에디터 라이브러리 조사
3. 또는 STT 중 키보드 입력 금지를 명확히 안내

**세션 결과**: ❌ 완전 실패

