# 개발 세션 - 2025-10-11 20:55

## 세션 개요
- **시작 시간**: 2025년 10월 11일 20:55 (한국 시간)
- **현재 브랜치**: main
- **마지막 커밋**: c943df7 backend 운영 설정
- **Git 상태**:
  - 수정됨: 0_history.txt, 4_design_backend.txt

## 목표
이번 세션에서 달성하고자 하는 목표를 설정해주세요.

## 진행 상황
세션 진행 중 업데이트가 여기에 기록됩니다.

---

### 업데이트 - 2025-10-11 21:48

**요약**: 프리미엄 전용 서버 동기화 시스템 데이터베이스 설계 완료

**Git 변경 사항**:
- 수정됨: 4_design_backend.txt (서버 동기화 설계 추가)
- 현재 브랜치: main (커밋: cce7443 backend 서버 동기화 설계)

**할 일 진행 상황**: 할 일 목록 미사용 (문서 작업)

**작업 내용**:

1. **동기화 방식 비교 분석**
   - 수동 저장/받기 vs 자동 동기화 장단점 분석
   - Litten 앱에 적합한 하이브리드 전략 수립
   - 무료/스탠다드: 로컬 전용, 프리미엄: 지능형 자동 동기화

2. **비용 분석**
   - AWS S3 vs 자체 디스크 비용 상세 비교
   - S3 Standard: $0.023/GB/월
   - S3 Intelligent-Tiering: 자동 계층화로 비용 최적화
   - 결론: 초기 단계에서는 S3가 유리, 대규모는 하이브리드

3. **구독 모델 최종 확정**
   - 무료: 로컬만, 제한 있음, 광고 있음
   - 스탠다드: 로컬만, 무제한, 광고 제거
   - 프리미엄: 로컬+서버(S3), 로그인 필수, 동기화 지원

4. **프리미엄 전용 데이터베이스 테이블 설계 (8개)**
   - note_member: 구독 플랜 정보 추가 (ALTER TABLE)
   - note_litten: 리튼 공간 테이블
   - note_audio_file: 녹음 파일 테이블 (S3 저장)
   - note_handwriting_file: 필기 파일 테이블 (S3 저장)
   - note_text_file: 텍스트 파일 테이블 (FULLTEXT 검색 지원)
   - note_member_settings: 사용자 설정 테이블
   - note_subscription_history: 구독 이력 테이블
   - note_sync_log: 동기화 로그 테이블

5. **테이블 설계 핵심 원칙**
   - 무료/스탠다드 사용자는 서버 테이블 사용 안 함 (로컬 전용)
   - 프리미엄 사용자만 회원가입 후 서버 사용
   - 모든 파일은 S3 저장, DB에는 메타데이터만
   - 버전 관리 지원 (version 필드로 충돌 해결)
   - 논리 삭제 (is_deleted 플래그)
   - 동기화 타임스탬프 (created_at_device, updated_at_device, synced_at)

6. **비용 효율성 분석**
   - 전체 사용자 10,000명 기준
   - 프리미엄 전환율 5% (500명)
   - 서버 비용: 약 $22/월 (100GB S3 + 트래픽)
   - 프리미엄 수익: $2,495/월 ($4.99 × 500명)
   - 순익: $2,473/월 (약 320만원)

**문서 업데이트**:
- 4_design_backend.txt 섹션 12 추가
  - 12.1: 동기화 방식 비교
  - 12.2: 하이브리드 전략
  - 12.3: S3 vs 디스크 비용 분석
  - 12.4: 구독 모델 정리
  - 12.5: 프리미엄 전용 테이블 설계 (8개)
  - 12.6: ER 다이어그램
  - 12.7: 저장 용량 추정
  - 12.8: 비용 분석

**설계 특징**:
- 클라이언트 생성 UUID (오프라인 동기화 대비)
- 증분 동기화 지원 (updated_at_device 기준)
- S3 Pre-signed URL 방식 (보안)
- CloudFront CDN 통합 가능
- 대용량 텍스트는 S3 저장 옵션

**다음 단계**:
- 동기화 API 설계 (GET /api/v1/sync/changes)
- 충돌 해결 로직 설계
- 클라이언트 동기화 로직 구현
- 구독 결제 시스템 통합 (Apple/Google IAP)

---

## 세션 종료 요약

### 세션 정보
- **종료 시간**: 2025년 10월 11일 21:49 (한국 시간)
- **세션 소요 시간**: 약 54분 (20:55 ~ 21:49)
- **최종 브랜치**: main
- **최종 커밋**: cce7443 backend 서버 동기화 설계

### Git 변경 사항 요약
**변경된 파일 수**: 총 1개
- **수정됨** (1개):
  - `.claude/sessions/2025-10-11-2055.md` (세션 로그)
  - `4_design_backend.txt` (백엔드 설계 문서 - 섹션 12 추가)

**커밋 수**: 1개 (cce7443 backend 서버 동기화 설계)

**최종 Git 상태**: 세션 로그 파일 수정됨 (커밋되지 않음)

### 할 일 요약
- **할 일 목록**: 미사용 (문서 설계 작업)
- **완료된 작업**: 프리미엄 전용 서버 동기화 시스템 데이터베이스 설계 완료
- **미완료 작업**: 없음 (계획된 작업 모두 완료)

### 주요 성과

#### 1. 동기화 전략 수립
- 수동 저장/받기 vs 자동 동기화 방식 비교 분석 완료
- 하이브리드 전략 수립: 
  - 무료/스탠다드: 로컬 전용 (수동 백업/복원)
  - 프리미엄: 지능형 자동 동기화 (3가지 옵션 제공)

#### 2. 비용 최적화 분석
- AWS S3 vs 자체 디스크 상세 비용 비교 완료
- 결론: 초기~성장기는 S3 Standard/Intelligent-Tiering 추천
- 대규모 시 하이브리드 전략 (S3 + 자체 스토리지)

#### 3. 구독 모델 최종 확정
- 3단계 구독 모델 명확히 정의:
  - 무료: 로컬만, 제한 있음, 광고 있음, 로그인 불가
  - 스탠다드: 로컬만, 무제한, 광고 제거, 로그인 불가
  - 프리미엄: 로컬+서버, 무제한, 광고 제거, 로그인 필수
- 핵심: 무료/스탠다드는 서버 비용 없음, 프리미엄만 서버 사용

#### 4. 프리미엄 전용 데이터베이스 설계 완료
8개 테이블 상세 설계:
- note_member (구독 정보 추가)
- note_litten (리튼 공간)
- note_audio_file (녹음 파일)
- note_handwriting_file (필기 파일)
- note_text_file (텍스트 파일, FULLTEXT 검색)
- note_member_settings (사용자 설정)
- note_subscription_history (구독 이력)
- note_sync_log (동기화 로그)

### 구현된 기능 (설계)

#### 1. 테이블 설계 핵심 원칙
```sql
-- 공통 필드 패턴:
- *_uuid: 클라이언트 생성 UUID (오프라인 동기화)
- version: 버전 번호 (충돌 해결)
- is_deleted: 논리 삭제 플래그
- created_at_device: 클라이언트 생성 시간
- updated_at_device: 클라이언트 수정 시간
- synced_at: 서버 동기화 시간
```

#### 2. note_member 구독 정보 추가
```sql
ALTER TABLE `note_member` 
ADD COLUMN `subscription_plan` VARCHAR(20) NOT NULL DEFAULT 'free' 
  COMMENT '구독 플랜 (free, standard, premium)',
ADD COLUMN `subscription_status` VARCHAR(20) NULL 
  COMMENT '구독 상태 (active, expired, cancelled)',
ADD COLUMN `subscription_start_date` TIMESTAMP NULL,
ADD COLUMN `subscription_end_date` TIMESTAMP NULL,
ADD COLUMN `last_payment_date` TIMESTAMP NULL;
```

#### 3. 파일 저장 전략
- 실제 파일: AWS S3 저장 (s3_bucket, s3_key, s3_url)
- 메타데이터: MariaDB 저장 (파일명, 크기, MIME, 썸네일 등)
- 대용량 텍스트: S3 저장 옵션 (is_s3_stored 플래그)
- 검색: content_plain 필드 + FULLTEXT INDEX

#### 4. 동기화 지원 설계
- 증분 동기화: updated_at_device 타임스탬프 기준
- 충돌 해결: version 필드로 Last-Write-Wins
- 동기화 로그: note_sync_log 테이블로 추적
- 기기 정보: device_id, device_type, app_version 기록

### 발생한 문제와 해결책

**문제 없음** - 순수 설계/문서 작업으로 구현이나 오류 발생하지 않음

### 주요 변경 사항

#### 문서 변경
**4_design_backend.txt 파일 업데이트**:
- 섹션 12 추가: "로컬 파일 서버 저장 전략 분석"
- 총 8개 하위 섹션 (12.1 ~ 12.8)
- 약 800줄 분량의 상세 설계 문서 추가

내용:
1. 동기화 방식 비교 (수동 vs 자동)
2. Litten 앱 하이브리드 전략
3. S3 vs 디스크 비용 분석 (상세 비교표 포함)
4. 최종 구독 모델 정리
5. 프리미엄 전용 테이블 설계 (8개 CREATE TABLE)
6. ER 다이어그램
7. 저장 용량 추정
8. 비용 분석 (수익성 계산)

### 설정 변경 사항

**없음** - 코드나 설정 변경 없이 순수 문서 작업

### 배포 단계

**해당 없음** - 설계 단계로 배포 작업 없음

### 얻은 교훈

#### 1. 구독 모델 설계
- 프리미엄만 서버 사용하는 전략이 비용 효율적
- 무료/스탠다드 사용자는 서버 비용이 전혀 없음
- 5% 전환율로도 충분한 수익 창출 가능

#### 2. 스토리지 선택
- 초기 단계: S3가 초기 투자 없고 확장성 좋음
- 성장 단계: S3 Intelligent-Tiering으로 비용 최적화
- 대규모: 하이브리드 전략 고려 (최근 데이터는 자체 서버)

#### 3. 데이터베이스 설계
- 클라이언트 UUID 방식으로 오프라인 동기화 대비
- version 필드로 충돌 해결 (Last-Write-Wins)
- 타임스탬프 3개 (created_at_device, updated_at_device, synced_at)로 정밀한 동기화 가능
- 논리 삭제로 데이터 복구 가능성 유지

#### 4. 비용 최적화
- S3 Lifecycle 정책으로 오래된 파일 저렴한 계층 이동
- CloudFront CDN으로 트래픽 비용 절감
- 압축 저장으로 용량 절감 (오디오 90%, 이미지 70%, 텍스트 80%)

### 완료되지 않은 작업

#### 다음 세션에서 진행할 작업:

1. **동기화 API 설계**
   - GET /api/v1/sync/changes (증분 동기화)
   - POST /api/v1/sync/upload (파일 업로드)
   - POST /api/v1/sync/resolve-conflict (충돌 해결)

2. **인증 API 설계**
   - POST /api/v1/auth/signup (프리미엄 회원가입)
   - POST /api/v1/auth/login (로그인)
   - POST /api/v1/auth/refresh (토큰 갱신)

3. **구독 관리 API 설계**
   - POST /api/v1/subscription/upgrade (프리미엄 구독)
   - GET /api/v1/subscription/status (구독 상태 조회)
   - POST /api/v1/subscription/verify-receipt (영수증 검증)

4. **Spring Boot Entity 클래스 생성**
   - 8개 테이블에 대한 JPA Entity 생성
   - Repository 인터페이스 생성
   - Service 레이어 구현

5. **S3 통합**
   - AWS SDK 설정
   - Pre-signed URL 생성 로직
   - 파일 업로드/다운로드 서비스

### 미래 개발자를 위한 팁

#### 1. 데이터베이스 마이그레이션
```sql
-- 기존 note_member 테이블에 구독 필드 추가
ALTER TABLE `note_member` 
ADD COLUMN `subscription_plan` VARCHAR(20) NOT NULL DEFAULT 'free',
ADD COLUMN `subscription_status` VARCHAR(20) NULL,
ADD COLUMN `subscription_start_date` TIMESTAMP NULL,
ADD COLUMN `subscription_end_date` TIMESTAMP NULL,
ADD COLUMN `last_payment_date` TIMESTAMP NULL,
ADD INDEX `index_subscription_plan` (`subscription_plan`);

-- 그 후 8개 신규 테이블 생성
-- 4_design_backend.txt 섹션 12.5 참조
```

#### 2. 프리미엄 사용자 확인 로직
```java
// Spring Security + JWT 예시
@PreAuthorize("hasRole('PREMIUM')")
public ResponseEntity<?> syncFiles() {
    Member member = getCurrentMember();
    
    // 구독 만료 확인
    if (member.getSubscriptionEndDate().isBefore(LocalDateTime.now())) {
        return ResponseEntity.status(403).body("Subscription expired");
    }
    
    // 동기화 처리
    return syncService.performSync(member.getUuid());
}
```

#### 3. 증분 동기화 쿼리
```sql
-- 클라이언트의 마지막 동기화 이후 변경된 항목 조회
SELECT * FROM note_litten 
WHERE uuid = ? 
  AND updated_at_device > ?
  AND is_deleted = 0
ORDER BY updated_at_device ASC;
```

#### 4. S3 파일 업로드
```java
// Pre-signed URL 방식 추천 (클라이언트 직접 업로드)
String presignedUrl = s3Client.generatePresignedUrl(
    bucketName, 
    s3Key, 
    Date.from(Instant.now().plus(15, ChronoUnit.MINUTES)),
    HttpMethod.PUT
);

// 클라이언트에게 URL 반환
return ResponseEntity.ok(Map.of(
    "upload_url", presignedUrl,
    "s3_key", s3Key,
    "expires_in", 900  // 15분
));
```

#### 5. 충돌 해결 전략
```
Last-Write-Wins (LWW):
1. 클라이언트와 서버의 version 비교
2. version이 높은 쪽이 최신 (서버 우선)
3. 클라이언트 version < 서버 version: 서버 데이터 다운로드
4. 클라이언트 version == 서버 version: 업로드 허용
5. 충돌 시 사용자에게 선택권 제공 (서버/클라이언트/병합)
```

#### 6. 비용 모니터링
- CloudWatch로 S3 사용량 모니터링
- 월별 트래픽 분석
- 사용자당 평균 저장량 추적
- 프리미엄 전환율 분석

#### 7. 보안 고려사항
- S3 Pre-signed URL 만료 시간: 15분
- JWT 토큰 만료: 1시간 (Refresh Token: 30일)
- 파일 접근 권한: uuid 일치 확인 필수
- HTTPS 강제 적용

### 기술 스택 요약
- **Frontend**: Flutter (Dart)
- **Backend**: Spring Boot 3.2.0, Java 17
- **Database**: MariaDB 10
- **Storage**: AWS S3 (파일), MariaDB (메타데이터)
- **Auth**: JWT + 이메일 로그인
- **Payment**: Apple IAP, Google Play Billing

### 비용 예상 (프리미엄 사용자 500명 기준)
- S3 저장: 100GB × $0.023 = $2.3/월
- S3 트래픽: 약 $10~20/월
- EC2/RDS: 약 $50/월 (별도)
- **총 서버 비용**: 약 $60~70/월
- **프리미엄 수익**: $2,495/월
- **순익**: 약 $2,430/월 (약 315만원)

### 최종 상태
- ✅ 동기화 전략 수립 완료
- ✅ 비용 분석 완료
- ✅ 구독 모델 최종 확정
- ✅ 데이터베이스 스키마 설계 완료 (8개 테이블)
- ✅ ER 다이어그램 작성 완료
- ✅ 문서화 완료 (4_design_backend.txt 섹션 12)
- ⏳ API 설계 대기 중
- ⏳ 구현 대기 중

### 문서 위치
- 백엔드 설계: [4_design_backend.txt](4_design_backend.txt) (섹션 12)
- 세션 로그: [.claude/sessions/2025-10-11-2055.md](.claude/sessions/2025-10-11-2055.md)

---
**세션 종료**: 2025년 10월 11일 21:49
