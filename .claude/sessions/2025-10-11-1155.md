# 개발 세션 - 2025-10-11 11:55

## 세션 개요
- **시작 시간**: 2025년 10월 11일 11:55 (한국 시간)
- **현재 브랜치**: main
- **마지막 커밋**: 0cbfdf2 UI 개선 끝
- **Git 상태**: 클린 상태

## 목표
이번 세션에서 달성하고자 하는 목표를 설정해주세요.

## 진행 상황
세션 진행 중 업데이트가 여기에 기록됩니다.

---

### 업데이트 - 2025-10-11 20:28

**요약**: Spring Boot backend WAR 파일 빌드 및 Tomcat 배포 설정 완료

**Git 변경 사항**:
- 수정됨: backend/pom.xml, backend/src/main/resources/application.yml, backend/src/main/resources/log4j2/log4j2-local.xml, 0_history.txt
- 추가됨: backend/src/main/resources/log4j2/log4j2.xml
- 현재 브랜치: main (커밋: 95ac3f1 backend 운영 설정)

**할 일 진행 상황**: 할 일 목록 미사용

**발생한 이슈**:
1. JWT Token ClassNotFoundException - javax.xml.bind.DatatypeConverter 클래스를 찾을 수 없음
2. Log4j2 설정 오류 - 잘못된 Filters 섹션 배치로 인한 시작 실패
3. server.port placeholder 해결 오류 - StartLittenApplication.java에서 참조하는 포트 설정이 주석 처리됨
4. Tomcat 서버 포트 설정 문제 - 9079 포트 BindException (주소 이미 사용 중)
5. Tomcat 서버 접속 불가 - 9080 포트가 HTTP Connector가 아닌 Shutdown 포트로 설정됨

**구현된 해결책**:
1. **JAXB 의존성 추가** (pom.xml):
   - javax.xml.bind:jaxb-api:2.3.1
   - org.glassfish.jaxb:jaxb-runtime:2.3.1
   - JWT Token 처리를 위해 Java 11+ 환경에서 필요

2. **Log4j2 설정 수정** (log4j2-local.xml):
   - 잘못 배치된 <Filters> 섹션 제거
   - Console Appender만 유지하여 정상 작동

3. **server.port 환경변수 설정** (application.yml):
   ```yaml
   server:
     port: ${PORT:8989}  # 환경변수 PORT 사용, 없으면 기본값 8989
   ```
   - 외부 Tomcat 배포 시 유연한 포트 관리
   - StartLittenApplication.java의 @Value("${server.port}") placeholder 해결

4. **불필요한 의존성 제거** (pom.xml):
   - Apache POI (poi, poi-ooxml)
   - com.auth0:java-jwt
   - spring-boot-starter-thymeleaf
   - spring-security-cas
   - commons-httpclient
   - com.ibm.icu:icu4j
   - WAR 파일 크기 96MB → 67MB로 30% 감소

5. **에러 로깅 개선** (CustomHttpService.java):
   - InvocationTargetException 별도 처리 추가
   - e.getCause()로 실제 예외 원인 로깅

**변경된 코드 내용**:

1. **backend/src/main/resources/application.yml**:
   - 데이터베이스 URL: jdbc:mariadb://localhost:3306/litten7
   - 데이터베이스 비밀번호: zaq1!@2wsxN
   - server.port: ${PORT:8989}
   - context-path: /litten (유지)

2. **backend/pom.xml**:
   - JAXB 의존성 추가
   - 6개 불필요한 의존성 제거
   - spring-boot-starter-tomcat scope="provided" 유지

3. **backend/src/main/resources/log4j2/log4j2-local.xml**:
   - 잘못된 Filters 섹션 제거
   - Console Appender만 사용

4. **backend/src/main/java/com/litten/common/dynamic/CustomHttpService.java**:
   - InvocationTargetException 처리 추가
   - 실제 예외 원인 로깅 강화

**배포 파일**:
- WAR 파일: backend/target/litten-backend-0.0.1.war (67MB)
- 빌드 시간: 2025-10-11 16:43:32
- 배포 대상: Tomcat 10.0 (/litten7/tomcat/webapps/ROOT.war)

**미해결 이슈**:
- Tomcat server.xml 설정 문제:
  - 9080 포트가 HTTP Connector가 아닌 Server Shutdown 포트로 설정됨
  - curl 테스트 시 "Empty reply from server" 오류
  - 서버 로그: "유효하지 않은 셧다운 명령" 경고
  - 해결 방법: server.xml에서 Server shutdown 포트를 8005로, HTTP Connector를 9080 또는 9079로 설정 필요
  - 서버 관리자 권한 필요

**기술 스택**:
- Spring Boot 3.2.0
- JDK 17
- MariaDB 10
- Tomcat 10.0
- HikariCP
- Log4j2
- JWT (io.jsonwebtoken:jjwt:0.9.1)

---

## 세션 종료 요약

### 세션 정보
- **종료 시간**: 2025년 10월 11일 20:29 (한국 시간)
- **세션 소요 시간**: 약 8시간 34분 (11:55 ~ 20:29)
- **최종 브랜치**: main
- **최종 커밋**: 95ac3f1 backend 운영 설정

### Git 변경 사항 요약
**변경된 파일 수**: 총 6개
- **수정됨** (5개):
  - `.claude/sessions/2025-10-11-1155.md` (세션 로그)
  - `0_history.txt` (히스토리 기록)
  - `backend/pom.xml` (의존성 관리)
  - `backend/src/main/resources/application.yml` (애플리케이션 설정)
  - `backend/src/main/resources/log4j2/log4j2-local.xml` (로깅 설정)
- **추가됨** (1개):
  - `backend/src/main/resources/log4j2/log4j2.xml` (운영 로깅 설정)

**커밋 수**: 1개 (95ac3f1 backend 운영 설정)

**최종 Git 상태**: 수정된 파일 6개, 커밋되지 않음

### 할 일 요약
- **할 일 목록**: 미사용
- **완료된 작업**: 모든 계획된 작업 완료
- **미완료 작업**: 서버 설정 문제는 관리자 권한 필요로 보류

### 주요 성과

#### 1. Spring Boot Backend WAR 빌드 및 배포 준비 완료
- Spring Boot 3.2.0 + JDK 17 기반 WAR 파일 성공적으로 빌드
- Tomcat 10.0 외부 배포를 위한 설정 완료
- WAR 파일 크기 최적화: 96MB → 67MB (30% 감소)

#### 2. 5가지 주요 이슈 해결
- JWT Token ClassNotFoundException 해결
- Log4j2 설정 오류 수정
- server.port placeholder 문제 해결
- 의존성 최적화 완료
- 에러 로깅 개선

#### 3. 배포 환경 설정 완료
- MariaDB 연결 설정 완료
- Context-path `/litten` 유지
- 환경변수 기반 포트 관리 구현

### 구현된 기능

#### 1. JAXB 의존성 추가
```xml
<dependency>
    <groupId>javax.xml.bind</groupId>
    <artifactId>jaxb-api</artifactId>
    <version>2.3.1</version>
</dependency>
<dependency>
    <groupId>org.glassfish.jaxb</groupId>
    <artifactId>jaxb-runtime</artifactId>
    <version>2.3.1</version>
</dependency>
```
- **목적**: Java 11+ 환경에서 JWT Token 처리 지원
- **파일**: backend/pom.xml

#### 2. Log4j2 설정 수정
- **파일**: backend/src/main/resources/log4j2/log4j2-local.xml
- **변경**: 잘못 배치된 `<Filters>` 섹션 제거
- **결과**: Spring Boot 정상 시작

#### 3. 환경변수 기반 포트 설정
```yaml
server:
  port: ${PORT:8989}  # 환경변수 PORT 사용, 없으면 기본값 8989
```
- **파일**: backend/src/main/resources/application.yml
- **효과**: 
  - 외부 Tomcat 배포 시 포트 유연성 확보
  - StartLittenApplication.java의 placeholder 요구사항 충족

#### 4. CustomHttpService 에러 로깅 강화
```java
} catch(InvocationTargetException e) {
    log.error("InvocationTargetException in get method [" + methodName + "]", e);
    log.error("Real cause: ", e.getCause());
    result.put(ConstantsDynamic.TAG_RESULT, ConstantsDynamic.RESULT_FAIL);
    result.put(ConstantsDynamic.TAG_RESULT_MESSAGE, ConstantsDynamic.RESULT_FAIL_MESSAGE);
}
```
- **파일**: backend/src/main/java/com/litten/common/dynamic/CustomHttpService.java
- **개선**: InvocationTargetException의 실제 원인 로깅

### 발생한 문제와 해결책

#### 문제 1: JWT Token ClassNotFoundException
**증상**:
```
Caused by: java.lang.ClassNotFoundException: javax.xml.bind.DatatypeConverter
```
**원인**: Java 11+에서 JAXB가 제거됨, JWT 라이브러리(io.jsonwebtoken:jjwt:0.9.1)가 의존
**해결**: JAXB API 및 Runtime 의존성 추가

#### 문제 2: Log4j2 설정 오류
**증상**:
```
java.lang.IllegalArgumentException: found 1 argument placeholders, but provided 0 for pattern
```
**원인**: log4j2-local.xml에서 `<Filters>` 섹션이 잘못된 위치에 배치됨
**해결**: `<Filters>` 섹션 제거

#### 문제 3: server.port Placeholder 오류
**증상**:
```
Could not resolve placeholder 'server.port' in value "${server.port}"
```
**원인**: StartLittenApplication.java에서 `@Value("${server.port}")` 사용하는데 설정이 주석 처리됨
**해결**: `port: ${PORT:8989}` 설정으로 변경

#### 문제 4: Tomcat 9079 포트 BindException
**증상**: `java.net.BindException: 주소가 이미 사용 중입니다`
**원인**: Tomcat 재시작 시 이전 프로세스가 포트 점유
**결과**: 재시도 후 정상 시작

#### 문제 5: 9080 포트 접속 불가
**증상**: 
```
curl: (52) Empty reply from server
서버 로그: 유효하지 않은 셧다운 명령 [...] 받았습니다
```
**원인**: 9080 포트가 HTTP Connector가 아닌 Tomcat Server Shutdown 포트로 설정됨
**상태**: **미해결** - 서버 관리자 권한 필요

### 주요 변경 사항

#### 설정 변경
1. **application.yml**:
   - 데이터베이스 URL 변경: `jdbc:mariadb://localhost:3306/litten7`
   - 데이터베이스 비밀번호: `zaq1!@2wsxN`
   - 포트 설정: `${PORT:8989}`
   - Context-path 유지: `/litten`

2. **log4j2-local.xml**:
   - 잘못된 Filters 섹션 제거
   - Console Appender만 유지

#### 종속성 변경

**추가된 의존성** (2개):
- `javax.xml.bind:jaxb-api:2.3.1`
- `org.glassfish.jaxb:jaxb-runtime:2.3.1`

**제거된 의존성** (6개):
1. `org.apache.poi:poi:5.2.3`
2. `org.apache.poi:poi-ooxml:5.2.3`
3. `com.auth0:java-jwt:3.3.0`
4. `org.springframework.boot:spring-boot-starter-thymeleaf`
5. `org.springframework.security:spring-security-cas:5.3.0.RELEASE`
6. `commons-httpclient:commons-httpclient:3.1`
7. `com.ibm.icu:icu4j:60.2`

**제거 시도했으나 유지된 의존성**:
- `com.mashape.unirest:unirest-java` (TalkAlert.java, Sms.java에서 사용 중)

#### 코드 변경
- `CustomHttpService.java`: InvocationTargetException 처리 강화

### 배포 단계

1. **WAR 파일 빌드**:
   ```bash
   cd /Users/mymac/Desktop/litten/backend
   export JAVA_HOME=/opt/homebrew/Cellar/openjdk@17/17.0.16/libexec/openjdk.jdk/Contents/Home
   export PATH="$JAVA_HOME/bin:$PATH"
   /opt/homebrew/bin/mvn clean package -DskipTests
   ```

2. **빌드 결과**:
   - 파일: `backend/target/litten-backend-0.0.1.war`
   - 크기: 67MB (최적화 전 96MB)
   - 빌드 시간: 약 5초

3. **서버 배포**:
   - 배포 위치: `/litten7/tomcat/webapps/ROOT.war`
   - 배포 완료 시간: 16:50
   - 애플리케이션 시작 시간: 13.879초

4. **배포 확인**:
   - Spring Boot 정상 시작: ✅
   - HikariCP 연결 풀 정상: ✅ (total=3, active=0, idle=3)
   - Tomcat 서버 시작: ✅
   - HTTP 접속: ❌ (포트 설정 문제)

### 얻은 교훈

1. **Java 버전 호환성**:
   - Java 11+ 환경에서는 JAXB가 기본 포함되지 않음
   - JWT 라이브러리 사용 시 JAXB 의존성 명시 필요

2. **Log4j2 설정 검증**:
   - XML 구조가 잘못되면 명확하지 않은 에러 발생
   - 설정 파일은 반드시 스키마 검증 필요

3. **Spring Boot 외부 배포**:
   - `server.port`를 placeholder로 사용하는 경우 반드시 설정 필요
   - 환경변수 `${PORT:기본값}` 패턴으로 유연성 확보

4. **의존성 최적화**:
   - 사용하지 않는 의존성 제거로 WAR 크기 30% 감소
   - 제거 전 반드시 코드 검색으로 사용 여부 확인

5. **Tomcat 포트 설정**:
   - Tomcat server.xml의 Server 포트(shutdown)와 Connector 포트(HTTP)는 별개
   - 포트 혼동 시 "유효하지 않은 셧다운 명령" 경고 발생

### 완료되지 않은 작업

#### 1. Tomcat server.xml 포트 설정 문제
**문제**: 9080 포트가 HTTP Connector가 아닌 Server Shutdown 포트로 설정됨

**필요한 조치**:
```xml
<!-- 서버 관리자가 /litten7/tomcat/conf/server.xml 수정 필요 -->

<!-- 현재 잘못된 설정 (추정) -->
<Server port="9080" shutdown="SHUTDOWN">

<!-- 올바른 설정 -->
<Server port="8005" shutdown="SHUTDOWN">

<!-- HTTP Connector 확인 -->
<Connector port="9080" protocol="HTTP/1.1"
           connectionTimeout="20000"
           redirectPort="8443" />
```

**대안**: 9079 포트로 접속 시도 (이전 로그에서 HTTP 포트로 확인됨)

**책임**: 서버 관리자 권한 필요

### 미래 개발자를 위한 팁

#### 1. 로컬 개발 환경
```bash
# JDK 17 설정
export JAVA_HOME=/opt/homebrew/Cellar/openjdk@17/17.0.16/libexec/openjdk.jdk/Contents/Home
export PATH="$JAVA_HOME/bin:$PATH"

# WAR 빌드
cd /Users/mymac/Desktop/litten/backend
mvn clean package -DskipTests

# 로컬 실행 (standalone)
java -jar target/litten-backend-0.0.1.war --spring.profiles.active=local
```

#### 2. 데이터베이스 설정
- **Host**: localhost:3306
- **Database**: litten7
- **User**: litten7
- **Password**: zaq1!@2wsxN
- **Connection Pool**: HikariCP (max 3 connections)

#### 3. 서버 배포
- **WAR 파일**: `backend/target/litten-backend-0.0.1.war`
- **배포 위치**: `/litten7/tomcat/webapps/ROOT.war`
- **Context-path**: `/litten`
- **접속 URL**: `http://서버주소:포트/litten`

#### 4. 주의사항
- `server.port` 설정 제거하지 말 것 (StartLittenApplication.java에서 참조)
- Log4j2 설정 변경 시 XML 스키마 검증 필수
- 의존성 제거 전 반드시 코드 검색으로 사용 여부 확인
- Tomcat 포트 설정은 server.xml에서 관리 (Spring Boot 설정과 별개)

#### 5. 트러블슈팅
- **JWT Token 에러**: JAXB 의존성 확인
- **시작 실패**: Log4j2 설정 파일 검증
- **포트 바인딩 실패**: 기존 프로세스 확인 후 재시작
- **접속 불가**: Tomcat server.xml의 Connector 포트 확인

#### 6. 유용한 명령어
```bash
# 로그 확인
tail -f /litten7/tomcat/logs/catalina.out

# 포트 사용 확인
lsof -i :9080
lsof -i :9079

# 프로세스 확인
ps aux | grep tomcat

# Git 상태 확인
git status --porcelain
git log -1 --oneline
```

### 기술 스택 요약
- **Framework**: Spring Boot 3.2.0
- **JDK**: OpenJDK 17.0.16
- **Database**: MariaDB 10
- **Connection Pool**: HikariCP
- **Logging**: Log4j2
- **Security**: Spring Security + JWT (io.jsonwebtoken:jjwt:0.9.1)
- **Build Tool**: Maven
- **Application Server**: Tomcat 10.0
- **Packaging**: WAR (67MB)

### 최종 상태
- ✅ WAR 파일 빌드 완료
- ✅ 모든 컴파일 에러 해결
- ✅ Spring Boot 정상 시작
- ✅ 데이터베이스 연결 정상
- ❌ HTTP 접속 불가 (서버 포트 설정 문제, 관리자 권한 필요)

---
**세션 종료**: 2025년 10월 11일 20:29
